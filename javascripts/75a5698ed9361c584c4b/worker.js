!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=7)}([function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(1);e.yCbCrToRGB=function(){const t=[],e=[],s=[];for(let i=0;i<256;i+=1){t[i]=[],e[i]=(i-16)/219,s[i]=(i-128)/224;for(let e=0;e<256;e+=1)t[i][e]=[]}return function(i,r,h){const o=e[i],n=s[r],c=s[h];let a,f,d;return t[i][r][h]||((a=o+1.402*c)>=1?a=1:a<0&&(a=0),(f=o-.344136286*n-.714136286*c)>=1?f=1:f<0&&(f=0),(d=o+1.772*n)>=1?d=1:d<0&&(d=0),a=~~(255*a),f=~~(255*f),d=~~(255*d),t[i][r][h]=[a,f,d]),t[i][r][h]}}(),e.sign=function(t){return t<0?-1:1},e.toInt=function(t){return 0|t},e.toUInt=function(t){return Math.abs(0|t)},e.toShort=function(t){return t>=32768?32768:t<=-32768?-32768:t},e.ilog=function(t){let e=0;for(;0!==t;)e+=1,t>>>=1;return e},e.arrayFlip=function(t){let e;const s=[];for(e of t.keys())s[t[e]]=Number(e);return s};e.Bitstream=class{constructor(t,e){this.packet=t,this.packet.seek(e),this.bits=0,this.lookup=t.next16(),this.eos=!1}nextBits(t){if(0===t)return 0;if(t<=8)return this.readBits(t);if(t<=16)return this.readBits(8)<<t-8|this.readBits(t-8);if(t<=24)return this.readBits(8)<<t-16|this.readBits(8)<<t-8|this.readBits(t-16);if(t<=32)return this.readBits(8)<<t-24|this.readBits(8)<<t-16|this.readBits(8)<<t-8|this.readBits(t-24);throw new i.TheoraError("Bitstream can only read 0-32 bits at one time.")}nextUBits(t){return Math.abs(this.nextBits(t))}readBits(t){let e;const s=this.lookup>>>16-t;if(this.bits+t>=8&&!this.eos){e=8-this.bits,this.lookup<<=e;try{this.lookup|=this.packet.next8()}catch(t){this.eos=!0}this.lookup<<=t-e,this.bits=t-e}else{if(this.eos&&t>16-this.bits)throw new i.TheoraError("Bitstream: End of Stream");this.lookup<<=t,this.bits+=t}return this.lookup&=65535,s}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.TheoraError=class extends Error{constructor(t){super(t),this.name="TheoraError"}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(0),r=s(1);function h(t){return 116===t.get8(1)&&104===t.get8(2)&&101===t.get8(3)&&111===t.get8(4)&&114===t.get8(5)&&97===t.get8(6)}function o(t){return t.next8()+(t.next8()<<8)+(t.next8()<<16)+(t.next8()<<24)}function n(t,e,s,i,h){let o;if(t.length>32)throw new r.TheoraError("Stream undecodeable.");if(1===e.nextBits(1)){if(32===h)throw new r.TheoraError("Stream undecodeable.");return o=e.nextBits(5),s[i][t.length-1][parseInt(t,2)]=o,h+=1}h=n(t+="0",e,s,i,h),t=t.slice(0,-1),h=n(t+="1",e,s,i,h),t=t.slice(0,-1)}e.isTheora=h;e.Header=class{constructor(){this.vmaj=0,this.vmin=0,this.vrev=0,this.fmbw=0,this.fmbh=0,this.picw=0,this.pich=0,this.picx=0,this.picy=0,this.frn=0,this.frd=0,this.parn=0,this.pard=0,this.cs=0,this.nombr=0,this.qual=0,this.kfgshift=0,this.pf=0,this.nmbs=0,this.nlbs=0,this.flbw=0,this.flbh=0,this.nsbs=0,this.nbs=0,this.ncbs=0,this.fcbw=0,this.fcbh=0,this.vendor="",this.comments={},this.lflims=[],this.hts=[],this.qmats=[],this.acScale=[],this.dcScale=[],this.nbms=0,this.bms=[],this.nqrs=[[0,0,0],[0,0,0]],this.qrsizes=[],this.qrbmis=[]}decodeIdentificationHeader(t){if(128!==t.get8(0)&&!h(t))throw new r.TheoraError("Invalid identification header.");t.seek(7),this.vmaj=t.next8(),this.vmin=t.next8(),this.vrev=t.next8(),this.fmbw=t.next16(),this.fmbh=t.next16(),this.picw=t.next24(),this.pich=t.next24(),this.picx=t.next8(),this.picy=t.next8(),this.frn=t.next32(),this.frd=t.next32(),this.parn=t.next24(),this.pard=t.next24(),this.cs=t.next8(),this.nombr=t.next24();const e=t.next16();if(this.qual=e>>10,this.kfgshift=e>>5&31,this.pf=e>>3&3,0!=(7&e))throw new r.TheoraError("Invalid theora header");switch(this.nmbs=this.fmbw*this.fmbh,this.nlbs=4*this.nmbs,this.flbw=2*this.fmbw,this.flbh=2*this.fmbh,this.pf){case 0:this.nsbs=i.toInt((this.fmbw+1)/2)*i.toInt((this.fmbh+1)/2)+2*i.toInt((this.fmbw+3)/4)*i.toInt((this.fmbh+3)/4),this.nbs=6*this.fmbw*this.fmbh,this.ncbs=this.fmbw*this.fmbh,this.fcbw=this.fmbw,this.fcbh=this.fmbh;break;case 2:this.nsbs=i.toInt((this.fmbw+1)/2)*i.toInt((this.fmbh+1)/2)+2*i.toInt((this.fmbw+3)/4)*i.toInt((this.fmbh+1)/2),this.nbs=8*this.fmbw*this.fmbh,this.ncbs=2*this.fmbw*this.fmbh,this.fcbw=this.fmbw,this.fcbh=2*this.fmbh;break;case 3:this.nsbs=3*i.toInt((this.fmbw+1)/2)*i.toInt((this.fmbh+1)/2),this.nbs=12*this.fmbw*this.fmbh,this.ncbs=4*this.fmbw*this.fmbh,this.fcbw=2*this.fmbw,this.fcbh=2*this.fmbh;break;default:throw new r.TheoraError("Unknown pixel format.")}}decodeCommentHeader(t){let e,s,i,n;if(129!==t.get8(0)&&!h(t))throw new r.TheoraError("Invalid comment header.");for(t.seek(7),e=o(t),this.vendor="",n=0;n<e;n+=1)this.vendor+=String.fromCharCode(t.next8());const c=o(t);for(this.comments={},i=0;i<c;i+=1){for(e=o(t),s="",n=0;n<e;n+=1)s+=String.fromCharCode(t.next8());(s=s.split("="))[0].length>0&&(this.comments[s[0].toLowerCase()]=s[1])}}decodeSetupHeader(t){if(130!==t.get8(0)&&!h(t))throw new r.TheoraError("Invalid setup header.");t.seek(7);const e=new i.Bitstream(t,7);this.lflims=function(t){let e;const s=[],i=t.nextBits(3);for(e=0;e<64;e+=1)s[e]=t.nextBits(i);return s}(e),this.decodeQuantizationParameters(e),this.hts=function(t){const e=[];let s,i;for(s=0;s<80;s+=1){for(e[s]=[],i=0;i<32;i+=1)e[s][i]=[];n("",t,e,s,0)}return e}(e)}computeQuantizationMatrices(){let t,e,s;for(this.qmats=[],t=0;t<2;t+=1)for(this.qmats[t]=[],e=0;e<3;e+=1)for(this.qmats[t][e]=[],s=0;s<64;s+=1)this.qmats[t][e][s]=this.computeQuantizationMatrix(t,e,s)}decodeQuantizationParameters(t){let e,s,h,o,n,c,a,f,d,l,b;for(d=t.nextBits(4)+1,n=0;n<64;n+=1)this.acScale[n]=t.nextUBits(d);for(d=t.nextBits(4)+1,n=0;n<64;n+=1)this.dcScale[n]=t.nextUBits(d);if(this.nbms=t.nextBits(9)+1,this.nbms>384)throw new r.TheoraError("Number of base matrices is too high.");for(c=0;c<this.nbms;c+=1)for(this.bms[c]=[],a=0;a<64;a+=1)this.bms[c][a]=t.nextBits(8);for(e=0;e<2;e+=1)for(this.qrsizes[e]=[],this.qrbmis[e]=[],h=0;h<3;h+=1){for(this.qrsizes[e][h]=[],this.qrbmis[e][h]=[],f=0;f<64;f+=1)this.qrsizes[e][h][f]=0,this.qrbmis[e][h][f]=0;if(l=1,(e>0||h>0)&&(l=t.nextBits(1)),0===l)b=0,e>0&&(b=t.nextBits(1)),1===b?(s=e-1,o=h):(s=i.toInt((3*e+h-1)/3),o=(h+2)%3),this.nqrs[e][h]=this.nqrs[s][o],this.qrsizes[e][h]=this.qrsizes[s][o],this.qrbmis[e][h]=this.qrbmis[s][o];else{if(f=0,n=0,this.qrbmis[e][h][f]=t.nextBits(i.ilog(this.nbms-1)),this.qrbmis[e][h][f]>=this.nbms)throw new r.TheoraError("Stream is undecodeable.");for(;n<63;)this.qrsizes[e][h][f]=t.nextBits(i.ilog(62-n))+1,n+=this.qrsizes[e][h][f],f+=1,this.qrbmis[e][h][f]=t.nextBits(i.ilog(this.nbms-1));if(n>63)throw new r.TheoraError("Stream is undecodeable.");this.nqrs[e][h]=f}}}computeQuantizationMatrix(t,e,s){const r=[];let h,o,n,c,a,f=0,d=0;for(h=0;h<63&&!(s<=(d+=this.qrsizes[t][e][h])&&f<=s);h+=1)f=d;const l=this.qrbmis[t][e][h],b=this.qrbmis[t][e][h+1];for(c=0;c<64;c+=1)a=i.toInt((2*(d-s)*this.bms[l][c]+2*(s-f)*this.bms[b][c]+this.qrsizes[t][e][h])/(2*this.qrsizes[t][e][h])),o=16,c>0&&0===t?o=8:0===c&&1===t&&(o=32),n=0===c?this.dcScale[s]:this.acScale[s],r[c]=Math.max(o,Math.min(4*i.toInt(n*a/100),4096));return r}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LONG_RUN_LENGTH_HUFFMAN_TABLE=[[[{rstart:1,rbits:0}],[{rstart:2,rbits:1}],[{rstart:4,rbits:1}],[{rstart:6,rbits:2}],[{rstart:10,rbits:3}],[{rstart:18,rbits:4},{rstart:34,rbits:12}]],[0,2,6,14,30,62]],e.SHORT_RUN_LENGTH_HUFFMAN_TABLE=[[[{rstart:1,rbits:1}],[{rstart:3,rbits:1}],[{rstart:5,rbits:1}],[{rstart:7,rbits:2}],[{rstart:11,rbits:2},{rstart:15,rbits:4}]],[0,2,6,14,30]],e.MACRO_BLOCK_MODE_SCHEMES=[null,[3,4,2,0,1,5,6,7],[3,4,0,2,1,5,6,7],[3,2,4,0,1,5,6,7],[3,2,0,4,1,5,6,7],[0,3,4,2,1,5,6,7],[0,5,3,4,2,1,6,7]],e.MACRO_BLOCK_MODE_SCHEMES_HUFFMAN_TABLE=[[[0],[1],[2],[3],[4],[5],[6,7]],[0,2,6,14,30,62,126,254]],e.MOTION_VECTOR_COMPONENTS_HUFFMAN_TABLE=[[[],[],[0,1,-1],[2,-2,3,-3],[],[4,-4,5,-5,6,-6,7,-7],[8,-8,9,-9,10,-10,11,-11,12,-12,13,-13,14,-14,15,-15],[16,-16,17,-17,18,-18,19,-19,20,-20,21,-21,22,-22,23,-23,24,-24,25,-25,26,-26,27,-27,28,-28,29,-29,30,-30,31,-31]],[0,0,0,6,0,40,96,224]],e.HUFFMAN_TABLE_GROUPS=[0,1,1,1,1,1,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],e.REFERENCE_FRAME_INDICIES=[1,0,1,1,1,2,2,1],e.DCPREDICTORS_WEIGHTS_AND_DIVISORS_TABLE={1000:{weights:[1,0,0,0],divisor:1},"0100":{weights:[0,1,0,0],divisor:1},1100:{weights:[1,0,0,0],divisor:1},"0010":{weights:[0,0,1,0],divisor:1},1010:{weights:[1,0,1,0],divisor:2},"0110":{weights:[0,0,1,0],divisor:1},1110:{weights:[29,-26,29,0],divisor:32},"0001":{weights:[0,0,0,1],divisor:1},1001:{weights:[75,0,0,53],divisor:128},"0101":{weights:[0,1,0,1],divisor:2},1101:{weights:[75,0,0,53],divisor:128},"0011":{weights:[0,0,1,0],divisor:1},1011:{weights:[75,0,0,53],divisor:128},"0111":{weights:[0,3,10,3],divisor:16},1111:{weights:[29,-26,29,0],divisor:32}},e.ZIG_ZAG_ORDER_MAPPING_TABLE=[[0,1,5,6,14,15,27,28],[2,4,7,13,16,26,29,42],[3,8,12,17,25,30,41,43],[9,11,18,24,31,40,44,53],[10,19,23,32,39,45,52,54],[20,22,33,38,46,51,55,60],[21,34,37,47,50,56,59,61],[35,36,48,49,57,58,62,63]],e.ROW_MAPPING_TABLE=[[[0],[0,1],[0,1,2],[0,1,2,3]],[[0,0],[0,0,1,1],[0,0,1,1,2,2],[0,0,1,1,2,3,3,2]],[[0,0,0],[0,0,1,1,1,0],[0,0,1,1,2,2,2,1,0],[0,0,1,1,2,3,3,2,2,3,1,0]],[[0,0,0,0],[0,0,1,1,1,1,0,0],[0,0,1,1,2,2,2,2,1,1,0,0],[0,0,1,1,2,3,3,2,2,3,3,2,1,1,0,0]]],e.COLUMN_MAPPING_TABLE=[[[0],[0,0],[0,0,0],[0,0,0,0]],[[0,1],[0,1,1,0],[0,1,1,0,0,1],[0,1,1,0,0,0,1,1]],[[0,1,2],[0,1,1,0,2,2],[0,1,1,0,0,1,2,2,2],[0,1,1,0,0,0,1,1,2,2,2,2]],[[0,1,2,3],[0,1,1,0,3,2,2,3],[0,1,1,0,0,1,2,3,3,2,2,3],[0,1,1,0,0,0,1,1,2,2,3,3,3,2,2,3]]],e.COSINES=[64277,60547,54491,46341,36410,25080,12785],e.SINES=[12785,25080,36410,46341,54491,60547,64277],e.INTRA_PREDICTOR=[[128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128]]},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.OggError=class extends Error{constructor(t){super(t),this.name="OggError"}}},,,function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(8),r=s(11),h=s(2),o=s(15),n=s(16);let c,a=!1;onmessage=(t=>{const e=t.data;if("command"===e.type)switch(e.command){case"init":!function(t){const e=new n.AjaxStream(t);e.fetch(()=>{const t=new r.TransportStream(e),s=t.findLogicalStreams();let n;for(let t=0;t<s.length;t+=1)if(h.isTheora(s[t].getFirstPacket())){n=s[t];break}if(!n)return postMessage({type:"error",message:"Invalid input file."}),void close();const a=new i.Decoder(n);c=new o.RGBRenderer(a,{withAlphaChannel:!0});const f={width:a.width,height:a.height,framerate:a.framerate};postMessage({type:"success",data:f})})}(e.url);break;case"decode":!function(){a=!0;const t=setInterval(()=>{a||clearInterval(t);const e=c.nextRGBFrame();e?function(t){postMessage({type:"data",frame:t.buffer},[t.buffer])}(e):(clearInterval(t),postMessage({type:"eos"}),close())},1)}();break;case"pause":a=!1;break;default:postMessage("Unknown command")}})},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(2),r=s(9),h=s(0),o=s(10);e.Decoder=class{constructor(t){this.stream=t,this.header=new i.Header,this.header.decodeIdentificationHeader(this.stream.nextPacket()),this.header.decodeCommentHeader(this.stream.nextPacket()),this.header.decodeSetupHeader(this.stream.nextPacket()),this.header.computeQuantizationMatrices(),this.mappingTables=function(t){let e;const s=[];let i=0;s[0]=o.computeSuperBlockSizes(t.flbw,t.flbh),s[1]=o.computeSuperBlockSizes(t.fcbw,t.fcbh),s[2]=s[1];const r=s[0].concat(s[1]).concat(s[2]);e=o.computeBlockToSuperBlockTable(t.flbw,t.flbh,s[0],i),i+=s[0].length,e.push(...o.computeBlockToSuperBlockTable(t.fcbw,t.fcbh,s[1],i)),i+=s[1].length,e.push(...o.computeBlockToSuperBlockTable(t.fcbw,t.fcbh,s[2],i));const n=e;i=0,e=o.computeRasterToCodedOrderMappingTable(t.flbw,t.flbh,n,r,i),i+=t.nlbs,e.push(...o.computeRasterToCodedOrderMappingTable(t.fcbw,t.fcbh,n,r,i)),i+=t.ncbs,e.push(...o.computeRasterToCodedOrderMappingTable(t.fcbw,t.fcbh,n,r,i));const c=e,a=h.arrayFlip(e);return{biToSbi:n,biToMbi:(e=o.computeMacroBlockMappingTables(t.fmbw,t.fmbh,t.pf,c))[0],mbiToBi:e[1],rasterToCodedOrder:c,codedToRasterOrder:a,superBlockSizes:r}}(this.header),this.colorPlaneOffsets=[0,this.header.nlbs,this.header.nlbs+this.header.ncbs],this.width=this.header.picw,this.height=this.header.pich,this.bitrate=this.header.nombr,this.comments=this.header.comments,this.vendor=this.header.vendor,this.framerate=this.header.frn/this.header.frd,this.pixelFormat=this.header.pf,this.xOffset=this.header.picx,this.yOffset=this.header.picy}nextFrame(){const t=this.stream.nextPacket();if(!t)return!1;const e=new r.Frame(this.header,t,this.mappingTables,this.colorPlaneOffsets,this.goldReferenceFrame,this.prevReferenceFrame);return e.decode(),0===e.ftype&&(this.goldReferenceFrame=e),this.prevReferenceFrame=e,e}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(0),r=s(3),h=s(1);e.Frame=class{constructor(t,e,s,r,h,o){this.recy=[],this.reccb=[],this.reccr=[],this.tables=s,this.colorPlaneOffsets=r,this.packet=e,this.header=t,this.mvects=[],this.coeffs=[],this.ncoeffs=[],this.bcoded=[],this.rpch=0,this.rpcw=0,this.rpyh=0,this.rpyw=0,this.qis=[],this.qiis=[],this.mbmodes=[],this.codedBlocks=[],this.uncodedBlocks=[],this.nqis=0,this.reader=new i.Bitstream(e,0),h&&(this.goldrefy=h.recy,this.goldrefcb=h.reccb,this.goldrefcr=h.reccr),o&&(this.prevrefy=o.recy,this.prevrefcb=o.reccb,this.prevrefcr=o.reccr),this.referenceFrames=[null,[this.prevrefy,this.prevrefcb,this.prevrefcr],[this.goldrefy,this.goldrefcb,this.goldrefcr]],this.changedPixels=[]}decode(){let t;if(this.packet.getLength()>0)this.decodeFrameHeader(),this.decodeCodedBlockFlags(),this.decodeMacroBlockCodingModes(),0!==this.ftype&&this.decodeMacroBlockMotionVectors(),this.decodeBlockLevelQiis(),this.decodeDCTCoefficients(),this.invertDCPrediction();else for(this.ftype=1,this.nqis=1,this.qis[0]=63,t=0;t<this.header.nbs;t+=1)this.bcoded[t]=0;this.rpyw=16*this.header.fmbw,this.rpyh=16*this.header.fmbh,0===this.header.pf?(this.rpcw=8*this.header.fmbw,this.rpch=8*this.header.fmbh):2===this.header.pf?(this.rpcw=8*this.header.fmbw,this.rpch=16*this.header.fmbh):3===this.header.pf&&(this.rpcw=16*this.header.fmbw,this.rpch=16*this.header.fmbh),this.reconstructComplete(),this.filterLoopComplete()}decodeFrameHeader(){let t,e;if(0!==this.reader.nextBits(1))throw new h.TheoraError("Unable to decode stream: invalid frame packet.");for(this.ftype=this.reader.nextBits(1),this.nqis=1,this.qis=[],this.qis[0]=this.reader.nextBits(6),t=this.reader.nextBits(1);1===t&&this.nqis<3;)this.qis[this.nqis]=this.reader.nextBits(6),this.nqis<2&&(t=this.reader.nextBits(1)),this.nqis+=1;if(0===this.ftype&&0!==(e=this.reader.nextBits(3)))throw new h.TheoraError("Unable to decode stream: used reserved bits.")}decodeRunLengthBitString(t,e){const s=[];let i,r=0;if(r===t)return s;for(i=this.reader.nextBits(1);;){const o=this.huffmanTableLookup(e),{rstart:n,rbits:c}=o,a=n+this.reader.nextBits(c);for(let t=0;t<a;t+=1)s.push(i);if((r+=a)===t)return s;if(r>t)throw new h.TheoraError("Invalid stream.");i=4129===a?this.reader.nextBits(1):1-i}}decodeCodedBlockFlags(){let t,e,s=[];const i=[];let h,o;if(this.codedBlocks=[],this.uncodedBlocks=[],0===this.ftype)for(o=0;o<this.header.nbs;o+=1)this.bcoded[o]=1,this.codedBlocks.push(o);else{for(s=this.decodeRunLengthBitString(this.header.nsbs,r.LONG_RUN_LENGTH_HUFFMAN_TABLE),t=0,h=0;h<this.header.nsbs;h+=1)0===s[h]&&(t+=1);for(e=this.decodeRunLengthBitString(t,r.LONG_RUN_LENGTH_HUFFMAN_TABLE),h=0;h<this.header.nsbs;h+=1)0===s[h]?i[h]=e.shift():i[h]=0;for(t=0,h=0;h<this.header.nsbs;h+=1)1===s[h]&&(t+=this.tables.superBlockSizes[h]);for(e=this.decodeRunLengthBitString(t,r.SHORT_RUN_LENGTH_HUFFMAN_TABLE),o=0;o<this.header.nbs;o+=1)0===s[h=this.tables.biToSbi[o]]?this.bcoded[o]=i[h]:this.bcoded[o]=e.shift(),0!==this.bcoded[o]?this.codedBlocks.push(o):this.uncodedBlocks.push(o)}}decodeMacroBlockCodingModes(){let t,e,s,i,h,o,n=[];if(this.mbmodes=[],0===this.ftype)for(e=0;e<this.header.nmbs;e+=1)this.mbmodes[e]=1;else{if(0===(t=this.reader.nextBits(3)))for(h=0;h<8;h+=1)n[i=this.reader.nextBits(3)]=h;else 7!==t&&(n=r.MACRO_BLOCK_MODE_SCHEMES[t]);for(e=0;e<this.header.nmbs;e+=1){for(o=4*e+4,s=4*e;s<o;s+=1)if(1===this.bcoded[s]){7===t?this.mbmodes[e]=this.reader.nextBits(3):(i=this.huffmanTableLookup(r.MACRO_BLOCK_MODE_SCHEMES_HUFFMAN_TABLE),this.mbmodes[e]=n[i]);break}this.mbmodes[e]=this.mbmodes[e]||0}}}huffmanTableLookup(t){let e,s=0,i=-1;const[r,h]=t;do{i+=1,e=(s+=this.reader.nextBits(1))-h[i],s<<=1}while(void 0===r[i][e]);return r[i][e]}dynamicHuffmanTableLookup(t){let e,s=0,i=-1;do{i+=1,e=s+=this.reader.nextBits(1),s<<=1}while(!Object.prototype.hasOwnProperty.call(t[i],e));return t[i][e]}decodeMotionVector(t){let e,s,i;return 0===t?(s=this.huffmanTableLookup(r.MOTION_VECTOR_COMPONENTS_HUFFMAN_TABLE),i=this.huffmanTableLookup(r.MOTION_VECTOR_COMPONENTS_HUFFMAN_TABLE)):(s=this.reader.nextBits(5),1===(e=this.reader.nextBits(1))&&(s=-s),i=this.reader.nextBits(5),1===(e=this.reader.nextBits(1))&&(i=-i)),[s,i]}decodeMacroBlockMotionVectors(){let t,e,s,i,r,h,o,n,c,a,f,d,l,b,m,u,p=[0,0],g=[0,0],x=0,B=0,v=0;const w=this.reader.nextBits(1);for(v=0;v<this.header.nmbs;v+=1){if(7===this.mbmodes[v]){switch(t=(l=this.tables.mbiToBi[v])[0],e=l[1],s=l[2],i=l[3],0!==this.bcoded[t]?(x=(m=this.decodeMotionVector(w))[0],B=m[1],this.mvects[t]=m):this.mvects[t]=[0,0],0!==this.bcoded[e]?(x=(m=this.decodeMotionVector(w))[0],B=m[1],this.mvects[e]=m):this.mvects[e]=[0,0],0!==this.bcoded[s]?(x=(m=this.decodeMotionVector(w))[0],B=m[1],this.mvects[s]=m):this.mvects[s]=[0,0],0!==this.bcoded[i]?(x=(m=this.decodeMotionVector(w))[0],B=m[1],this.mvects[i]=m):this.mvects[i]=[0,0],this.header.pf){case 0:r=l[4],h=l[5],(m=[])[0]=Math.round((this.mvects[t][0]+this.mvects[e][0]+this.mvects[s][0]+this.mvects[i][0])/4),m[1]=Math.round((this.mvects[t][1]+this.mvects[e][1]+this.mvects[s][1]+this.mvects[i][1])/4),this.mvects[r]=m,this.mvects[h]=m;break;case 2:r=l[4],h=l[5],o=l[6],n=l[7],(m=[])[0]=Math.round((this.mvects[t][0]+this.mvects[e][0])/2),m[1]=Math.round((this.mvects[t][1]+this.mvects[e][1])/2),this.mvects[r]=m,this.mvects[o]=m,(m=[])[0]=Math.round((this.mvects[s][0]+this.mvects[i][0])/2),m[1]=Math.round((this.mvects[s][1]+this.mvects[i][1])/2),this.mvects[h]=m,this.mvects[n]=m;break;default:r=l[4],h=l[5],o=l[6],n=l[7],c=l[8],a=l[9],f=l[10],d=l[11],this.mvects[r]=this.mvects[t],this.mvects[c]=this.mvects[t],this.mvects[h]=this.mvects[e],this.mvects[a]=this.mvects[e],this.mvects[o]=this.mvects[s],this.mvects[f]=this.mvects[s],this.mvects[n]=this.mvects[i],this.mvects[d]=this.mvects[i]}g=p,p=[x,B]}else 6===this.mbmodes[v]?(x=(m=this.decodeMotionVector(w))[0],B=m[1]):4===this.mbmodes[v]?(x=g[0],B=g[1],g=p,p=[x,B]):3===this.mbmodes[v]?(x=p[0],B=p[1]):2===this.mbmodes[v]?(g=p,p=[x=(m=this.decodeMotionVector(w))[0],B=m[1]]):(x=0,B=0);if(7!==this.mbmodes[v])for(u=0;u<this.tables.mbiToBi[v].length;u+=1)b=this.tables.mbiToBi[v][u],this.mvects[b]=[x,B]}}decodeBlockLevelQiis(){let t,e,s,i;for(this.qiis=[],s=0;s<this.header.nbs;s+=1)this.qiis[s]=0;for(i=0;i<this.nqis-1;i+=1){for(t=0,s=0;s<this.header.nbs;s+=1)0!==this.bcoded[s]&&this.qiis[s]===i&&(t+=1);for(e=this.decodeRunLengthBitString(t,r.LONG_RUN_LENGTH_HUFFMAN_TABLE),s=0;s<this.header.nbs;s+=1)0!==this.bcoded[s]&&this.qiis[s]===i&&(this.qiis[s]+=e.shift())}}decodeEOBToken(t,e,s,i){let r,h,o,n;switch(t){case 0:r=1;break;case 1:r=2;break;case 2:r=3;break;case 3:r=this.reader.nextBits(2)+4;break;case 4:r=this.reader.nextBits(3)+8;break;case 5:r=this.reader.nextBits(4)+16;break;default:if(0===(r=this.reader.nextBits(12))){for(h=0,n=0;n<this.codedBlocks.length&&!(e[h]<64);n+=1)h+=1;r=h}}for(o=i;o<64;o+=1)this.coeffs[s][o]=0;return this.ncoeffs[s]=e[s],e[s]=64,r-=1}decodeCoefficientToken(t,e,s,i){let r,o,n,c;switch(t){case 7:for(n=this.reader.nextBits(3),n+=1,c=i;c<i+n;c+=1)this.coeffs[s][c]=0;e[s]+=n;break;case 8:for(n=this.reader.nextBits(6),n+=1,c=i;c<i+n;c+=1)this.coeffs[s][c]=0;e[s]+=n;break;case 9:this.coeffs[s][i]=1,e[s]+=1,this.ncoeffs[s]=e[s];break;case 10:this.coeffs[s][i]=-1,e[s]+=1,this.ncoeffs[s]=e[s];break;case 11:this.coeffs[s][i]=2,e[s]+=1,this.ncoeffs[s]=e[s];break;case 12:this.coeffs[s][i]=-2,e[s]+=1,this.ncoeffs[s]=e[s];break;case 13:r=this.reader.nextBits(1),this.coeffs[s][i]=0===r?3:-3,e[s]+=1,this.ncoeffs[s]=e[s];break;case 14:r=this.reader.nextBits(1),this.coeffs[s][i]=0===r?4:-4,e[s]+=1,this.ncoeffs[s]=e[s];break;case 15:r=this.reader.nextBits(1),this.coeffs[s][i]=0===r?5:-5,e[s]+=1,this.ncoeffs[s]=e[s];break;case 16:r=this.reader.nextBits(1),this.coeffs[s][i]=0===r?6:-6,e[s]+=1,this.ncoeffs[s]=e[s];break;case 17:r=this.reader.nextBits(1),o=this.reader.nextBits(1),o+=7,this.coeffs[s][i]=0===r?o:-o,e[s]+=1,this.ncoeffs[s]=e[s];break;case 18:r=this.reader.nextBits(1),o=this.reader.nextBits(2),o+=9,this.coeffs[s][i]=0===r?o:-o,e[s]+=1,this.ncoeffs[s]=e[s];break;case 19:r=this.reader.nextBits(1),o=this.reader.nextBits(3),o+=13,this.coeffs[s][i]=0===r?o:-o,e[s]+=1,this.ncoeffs[s]=e[s];break;case 20:r=this.reader.nextBits(1),o=this.reader.nextBits(4),o+=21,this.coeffs[s][i]=0===r?o:-o,e[s]+=1,this.ncoeffs[s]=e[s];break;case 21:r=this.reader.nextBits(1),o=this.reader.nextBits(5),o+=37,this.coeffs[s][i]=0===r?o:-o,e[s]+=1,this.ncoeffs[s]=e[s];break;case 22:r=this.reader.nextBits(1),o=this.reader.nextBits(9),o+=69,this.coeffs[s][i]=0===r?o:-o,e[s]+=1,this.ncoeffs[s]=e[s];break;case 23:this.coeffs[s][i]=0,r=this.reader.nextBits(1),this.coeffs[s][i+1]=0===r?1:-1,e[s]+=2,this.ncoeffs[s]=e[s];break;case 24:for(c=i;c<i+2;c+=1)this.coeffs[s][c]=0;r=this.reader.nextBits(1),this.coeffs[s][i+2]=0===r?1:-1,e[s]+=3,this.ncoeffs[s]=e[s];break;case 25:for(c=i;c<i+3;c+=1)this.coeffs[s][c]=0;r=this.reader.nextBits(1),this.coeffs[s][i+3]=0===r?1:-1,e[s]+=4,this.ncoeffs[s]=e[s];break;case 26:for(c=i;c<i+4;c+=1)this.coeffs[s][c]=0;r=this.reader.nextBits(1),this.coeffs[s][i+4]=0===r?1:-1,e[s]+=5,this.ncoeffs[s]=e[s];break;case 27:for(c=i;c<i+5;c+=1)this.coeffs[s][c]=0;r=this.reader.nextBits(1),this.coeffs[s][i+5]=0===r?1:-1,e[s]+=6,this.ncoeffs[s]=e[s];break;case 28:for(r=this.reader.nextBits(1),n=this.reader.nextBits(2),n+=6,c=i;c<i+n;c+=1)this.coeffs[s][c]=0;this.coeffs[s][i+n]=0===r?1:-1,e[s]+=n+1,this.ncoeffs[s]=e[s];break;case 29:for(r=this.reader.nextBits(1),n=this.reader.nextBits(3),n+=10,c=i;c<i+n;c+=1)this.coeffs[s][c]=0;this.coeffs[s][i+n]=0===r?1:-1,e[s]+=n+1,this.ncoeffs[s]=e[s];break;case 30:this.coeffs[s][i]=0,r=this.reader.nextBits(1),o=this.reader.nextBits(1),o+=2,this.coeffs[s][i+1]=0===r?o:-o,e[s]+=2,this.ncoeffs[s]=e[s];break;case 31:for(r=this.reader.nextBits(1),o=this.reader.nextBits(1),o+=2,n=this.reader.nextBits(1),n+=2,c=i;c<i+n;c+=1)this.coeffs[s][c]=0;this.coeffs[s][i+n]=0===r?o:-o,e[s]+=n+1,this.ncoeffs[s]=e[s];break;default:throw new h.TheoraError("Unable to decode stream: invalid frame packet.")}}decodeDCTCoefficients(){let t,e,s,i,h=0,o=0;const n=[];let c,a,f;const d=this.codedBlocks.slice();let l,b=d.length;for(t=0;t<this.header.nbs;t+=1)for(n[t]=0,this.ncoeffs[t]=0,this.coeffs[t]=[],l=0;l<64;l+=1)this.coeffs[t][l]=0;for(c=0,e=0;e<64;e+=1)for(0!==e&&1!==e||(h=this.reader.nextBits(4),o=this.reader.nextBits(4)),l=0;l<b;l+=1)if(n[t=d[l]]===e){if(this.ncoeffs[t]=e,c>0){for(s=e;s<64;s+=1)this.coeffs[t][s]=0;n[t]=64,c-=1}else f=r.HUFFMAN_TABLE_GROUPS[e],i=t<this.header.nlbs?16*f+h:16*f+o,(a=this.dynamicHuffmanTableLookup(this.header.hts[i]))<7?c=this.decodeEOBToken(a,n,t,e):this.decodeCoefficientToken(a,n,t,e);64===n[t]&&(d.splice(l,1),l-=1,b-=1)}}computeDCPredictor(t,e){let s;const h=[],o=[];let n,c,a,f,d=0,l=this.header.flbw;const b=this.tables.biToMbi[t],m=r.REFERENCE_FRAME_INDICIES[this.mbmodes[b]];t>=this.header.nlbs+this.header.ncbs?(d=2,l=this.header.fcbw):t>=this.header.nlbs&&(d=1,l=this.header.fcbw);const u=this.tables.codedToRasterOrder[t]-this.colorPlaneOffsets[d];return h[0]=0,u%l!=0&&(a=this.tables.rasterToCodedOrder[u-1+this.colorPlaneOffsets[d]],0!==this.bcoded[a]&&(f=this.tables.biToMbi[a],m===r.REFERENCE_FRAME_INDICIES[this.mbmodes[f]]&&(h[0]=1,o[0]=a))),h[1]=0,u%l!=0&&u>=l&&(a=this.tables.rasterToCodedOrder[u-1-l+this.colorPlaneOffsets[d]],0!==this.bcoded[a]&&(f=this.tables.biToMbi[a],m===r.REFERENCE_FRAME_INDICIES[this.mbmodes[f]]&&(h[1]=1,o[1]=a))),h[2]=0,u>=l&&(a=this.tables.rasterToCodedOrder[u-l+this.colorPlaneOffsets[d]],0!==this.bcoded[a]&&(f=this.tables.biToMbi[a],m===r.REFERENCE_FRAME_INDICIES[this.mbmodes[f]]&&(h[2]=1,o[2]=a))),h[3]=0,(u+1)%l!=0&&u>=l&&(a=this.tables.rasterToCodedOrder[u+1-l+this.colorPlaneOffsets[d]],0!==this.bcoded[a]&&(f=this.tables.biToMbi[a],m===r.REFERENCE_FRAME_INDICIES[this.mbmodes[f]]&&(h[3]=1,o[3]=a))),0===h[0]&&0===h[1]&&0===h[2]&&0===h[3]?s=e[m]:(n=r.DCPREDICTORS_WEIGHTS_AND_DIVISORS_TABLE[h.join("")].weights,c=r.DCPREDICTORS_WEIGHTS_AND_DIVISORS_TABLE[h.join("")].divisor,s=0,0!==h[0]&&(s+=n[0]*this.coeffs[o[0]][0]),0!==h[1]&&(s+=n[1]*this.coeffs[o[1]][0]),0!==h[2]&&(s+=n[2]*this.coeffs[o[2]][0]),0!==h[3]&&(s+=n[3]*this.coeffs[o[3]][0]),s=i.toInt(s/c),0!==h[0]&&0!==h[1]&&0!==h[2]&&(Math.abs(s-this.coeffs[o[2]][0])>128?s=this.coeffs[o[2]][0]:Math.abs(s-this.coeffs[o[0]][0])>128?s=this.coeffs[o[0]][0]:Math.abs(s-this.coeffs[o[1]][0])>128&&(s=this.coeffs[o[1]][0]))),s}invertDCPrediction(){let t;const e=[];let s,i,h,o,n,c,a;for(a=0;a<3;a+=1)for(e[0]=0,e[1]=0,e[2]=0,o=0===a?this.header.nlbs:this.header.ncbs,h=0;h<o;h+=1)i=this.tables.rasterToCodedOrder[h+this.colorPlaneOffsets[a]],0!==this.bcoded[i]&&(t=this.computeDCPredictor(i,e),(s=this.coeffs[i][0]+t)>=32768?s=32768:s<=-32768&&(s=-32768),this.coeffs[i][0]=s,n=this.tables.biToMbi[i],e[c=r.REFERENCE_FRAME_INDICIES[this.mbmodes[n]]]=s)}getWholePixelPredictor(t,e,s,i,r,h,o){const n=[];let c,a,f,d;const l=r+o,b=i+h;for(a=0;a<8;a+=1)if((d=l+a)>e-1?d=e-1:d<0&&(d=0),n[a]=[],(f=b)<0)for(c=0;c<8;c+=1)n[a][c]=f<0?s[d][0]:s[d][f],f+=1;else if(f+7>t-1)for(c=0;c<8;c+=1)n[a][c]=f>t-1?s[d][t-1]:s[d][f],f+=1;else n[a][0]=s[d][f],n[a][1]=s[d][f+1],n[a][2]=s[d][f+2],n[a][3]=s[d][f+3],n[a][4]=s[d][f+4],n[a][5]=s[d][f+5],n[a][6]=s[d][f+6],n[a][7]=s[d][f+7];return n}getHalfPixelPredictor(t,e,s,i,r,h,o,n,c){const a=[];let f,d,l,b,m,u;const p=r+o,g=i+h,x=r+c,B=i+n;for(d=0;d<8;d+=1)for((b=p+d)>e-1?b=e-1:b<0&&(b=0),(u=x+d)>e-1?u=e-1:u<0&&(u=0),a[d]=[],f=0;f<8;f+=1)(l=g+f)>t-1?l=t-1:l<0&&(l=0),(m=B+f)>t-1?m=t-1:m<0&&(m=0),a[d][f]=s[b][l]+s[u][m]>>1;return a}dequantize(t,e,s,i,h){const o=[];let n,c,a,f,d,l;for(n=this.header.qmats[t][e][s],(f=this.coeffs[h][0]*n[0])>=32768?f=32768:f<=-32768&&(f=-32768),o[0]=f,n=this.header.qmats[t][e][i],c=1,l=1,d=0;d<8;d+=1){for(;l<8;)a=r.ZIG_ZAG_ORDER_MAPPING_TABLE[d][l],(f=this.coeffs[h][a]*n[c])>=32768?f=32768:f<=-32768&&(f=-32768),o[c]=f,c+=1,l+=1;l=0}return o}invertDCT1D(t){const e=[],s=[];let i;const h=r.COSINES[2],o=r.COSINES[3],n=r.COSINES[5],c=r.COSINES[6],a=r.SINES[2],f=r.SINES[5],d=r.SINES[6];return s[0]=t[0]+t[4],s[0]>=32768?s[0]=32768:s[0]<=-32768&&(s[0]=-32768),s[0]=o*s[0]>>16,s[1]=t[0]-t[4],s[1]>=32768?s[1]=32768:s[1]<=-32768&&(s[1]=-32768),s[1]=o*s[1]>>16,s[2]=(n*t[2]>>16)-(f*t[6]>>16),s[3]=(f*t[2]>>16)+(n*t[6]>>16),s[4]=(c*t[1]>>16)-(d*t[7]>>16),s[5]=(h*t[5]>>16)-(a*t[3]>>16),s[6]=(a*t[5]>>16)+(h*t[3]>>16),s[7]=(d*t[1]>>16)+(c*t[7]>>16),i=s[4]+s[5],s[5]=s[4]-s[5],s[5]>=32768?s[5]=32768:s[5]<=-32768&&(s[5]=-32768),s[5]=o*s[5]>>16,s[4]=i,i=s[7]+s[6],s[6]=s[7]-s[6],s[6]>=32768?s[6]=32768:s[6]<=-32768&&(s[6]=-32768),s[6]=o*s[6]>>16,s[7]=i,i=s[0]+s[3],s[3]=s[0]-s[3],s[0]=i,i=s[1]+s[2],s[2]=s[1]-s[2],s[1]=i,i=s[6]+s[5],s[5]=s[6]-s[5],s[6]=i,(i=s[0]+s[7])>=32768?i=32768:i<=-32768&&(i=-32768),e[0]=i,(i=s[1]+s[6])>=32768?i=32768:i<=-32768&&(i=-32768),e[1]=i,(i=s[2]+s[5])>=32768?i=32768:i<=-32768&&(i=-32768),e[2]=i,(i=s[3]+s[4])>=32768?i=32768:i<=-32768&&(i=-32768),e[3]=i,(i=s[3]-s[4])>=32768?i=32768:i<=-32768&&(i=-32768),e[4]=i,(i=s[2]-s[5])>=32768?i=32768:i<=-32768&&(i=-32768),e[5]=i,(i=s[1]-s[6])>=32768?i=32768:i<=-32768&&(i=-32768),e[6]=i,(i=s[0]-s[7])>=32768?i=32768:i<=-32768&&(i=-32768),e[7]=i,e}invertDCT2D(t){const e=[];let s,i,r,h=[];for(i=0;i<8;i+=1)s=8*i,h=t.slice(s,s+8),r=this.invertDCT1D(h),e[i]=r;for(s=0;s<8;s+=1){for(i=0;i<8;i+=1)h[i]=e[i][s];for(r=this.invertDCT1D(h),i=0;i<8;i+=1)e[i][s]=r[i]+8>>4}return e}setPixels1(t,e,s,i,r,h){let o,n,c,a,f;for(o=0;o<8;o+=1)for(t[a=s+o]||(t[a]=[]),n=0;n<8;n+=1)c=i+n,(f=r[o][n]+h)>255?f=255:f<0&&(f=0),0===e&&this.changedPixels.push([c,a]),t[a][c]=f}setPixels2(t,e,s,i,r,h){let o,n,c,a,f;for(o=0;o<8;o+=1)for(t[c=s+o]||(t[c]=[]),n=0;n<8;n+=1)a=i+n,(f=r[o][n]+h[o][n])>255?f=255:f<0&&(f=0),0===e&&this.changedPixels.push([a,c]),t[c][a]=f}reconstructComplete(){let t,e,s,h,o,n,c,a,f,d,l,b,m,u,p,g,x,B,v,w,T,E,P=[],O=0,_=2,k=2;if(this.recy=[],this.reccb=[],this.reccr=[],0!==this.ftype&&this.prevrefy&&this.prevrefcb&&this.prevrefcr){for(T=this.prevrefy.length,E=0;E<T;E+=1)this.recy[E]=this.prevrefy[E].slice(0);for(T=this.prevrefcb.length,E=0;E<T;E+=1)this.reccb[E]=this.prevrefcb[E].slice(0);for(T=this.prevrefcr.length,E=0;E<T;E+=1)this.reccr[E]=this.prevrefcr[E].slice(0)}h=this.recy;const S=this.qis[0];for(t=this.rpyw,e=this.rpyh,T=this.codedBlocks.length,E=0;E<T;E+=1)u=this.codedBlocks[E],p=this.tables.codedToRasterOrder[u],g=this.tables.biToMbi[u],x=r.REFERENCE_FRAME_INDICIES[this.mbmodes[g]],B=1===this.mbmodes[g]?0:1,u>=this.header.nlbs&&(t=this.rpcw,e=this.rpch,u>=this.header.nlbs+this.header.ncbs?(O=2,h=this.reccr):(O=1,h=this.reccb)),o=8*(p-this.colorPlaneOffsets[O])%t,n=(8*(p-this.colorPlaneOffsets[O])-o)/t*8,0===x?l=r.INTRA_PREDICTOR:(s=this.referenceFrames[x][O],O>0&&(0===this.header.pf?(_=4,k=4):2===this.header.pf&&(_=4)),c=Math.floor(Math.abs(this.mvects[u][0])/_)*i.sign(this.mvects[u][0]),a=Math.floor(Math.abs(this.mvects[u][1])/k)*i.sign(this.mvects[u][1]),f=Math.ceil(Math.abs(this.mvects[u][0])/_)*i.sign(this.mvects[u][0]),d=Math.ceil(Math.abs(this.mvects[u][1])/k)*i.sign(this.mvects[u][1]),l=c===f&&a===d?this.getWholePixelPredictor(t,e,s,o,n,c,a):this.getHalfPixelPredictor(t,e,s,o,n,c,a,f,d)),this.ncoeffs[u]<2?(b=this.header.qmats[B][O][S],(m=this.coeffs[u][0]*b[0]+15>>5)>=32768?m=32768:m<=-32768&&(m=-32768),this.setPixels1(h,O,n,o,l,m)):(v=this.qis[this.qiis[u]],w=this.dequantize(B,O,S,v,u),P=this.invertDCT2D(w),this.setPixels2(h,O,n,o,l,P))}getLflim(t,e){if(-e<t&&t<e)return t;const s=2*e;return t<=s||s<=t?0:t<=e?-t-s:-t+s}filterHorizontal(t,e,s,i){let r,h,o,n,c;const a=e+1,f=e+2,d=e+3;for(o=0;o<8;o+=1)r=t[c=s+o][e]-3*t[c][a]+3*t[c][f]-t[c][d]+4>>3,n=this.getLflim(r,i),(h=t[c][a]+n)>255?h=255:h<0&&(h=0),t[c][a]=h,(h=t[c][f]-n)>255?h=255:h<0&&(h=0),t[c][f]=h}filterVertical(t,e,s,i){let r,h,o,n,c;const a=s+1,f=s+2,d=s+3;for(o=0;o<8;o+=1)c=e+o,r=t[s][c]-3*t[a][c]+3*t[f][c]-t[d][c]+4>>3,n=this.getLflim(r,i),(h=t[a][c]+n)>255?h=255:h<0&&(h=0),t[a][c]=h,(h=t[f][c]-n)>255?h=255:h<0&&(h=0),t[f][c]=h}filterLoopComplete(){let t,e,s,i,r,h,o,n,c,a,f=0;const d=this.header.lflims[this.qis[0]];for(a=0;a<this.header.nbs;a+=1){if(n=this.tables.rasterToCodedOrder[a],0!==this.bcoded[n]){switch(f){case 0:s=this.recy,t=this.rpyw,e=this.rpyh;break;case 1:s=this.reccb,t=this.rpcw,e=this.rpch;break;default:s=this.reccr,t=this.rpcw,e=this.rpch}i=8*(a-this.colorPlaneOffsets[f])%t,r=(8*(a-this.colorPlaneOffsets[f])-i)/t*8,i>0&&(h=i-2,o=r,this.filterHorizontal(s,h,o,d)),r>0&&(h=i,o=r-2,this.filterVertical(s,h,o,d)),i+8<t&&(c=this.tables.rasterToCodedOrder[a+1],0===this.bcoded[c]&&(h=i+6,o=r,this.filterHorizontal(s,h,o,d))),r+8<e&&(c=this.tables.rasterToCodedOrder[a+t/8],0===this.bcoded[c]&&(h=i,o=r+6,this.filterVertical(s,h,o,d)))}a>=this.header.nlbs+this.header.ncbs-1?f=2:a>=this.header.nlbs-1&&(f=1)}}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(3);e.computeSuperBlockSizes=function(t,e){const s=[];let i,r,h=(t-t%4)/4,o=(e-e%4)/4,n=4,c=4,a=4;for(h<t/4&&(a=t-4*h,h+=1),o<e/4&&(c=e-4*o,o+=1),i=0;i<o;i+=1){for(n=i<o-1?4:c,r=0;r<h-1;r+=1)s[i*h+r]=4*n;s[i*h+r]=n*a}return s},e.computeBlockToSuperBlockTable=function(t,e,s,i){const r=[],h=t*e;let o,n=0,c=0;for(i=i||0,o=0;o<h;o+=1)o-(c+s[n])==0&&(c+=s[n],n+=1),r[o]=n+i;return r},e.computeRasterToCodedOrderMappingTable=function(t,e,s,r,h){const o=[];let n,c;const a=t*e;let f,d,l=0,b=0,m=4,u=4,p=0,g=0;for(16!==r[c=s[h]]&&(t<4&&(m=t),e<4&&(u=e)),n=0;n<a;n+=1)s[h+n]>c&&((b+=m)>=t&&(b=0,l+=u),p+=r[c],m=b+4<=t?4:t-b,u=l+4<=e?4:e-l,c+=1),g=n-p,o[(f=l+i.ROW_MAPPING_TABLE[m-1][u-1][g])*t+(d=b+i.COLUMN_MAPPING_TABLE[m-1][u-1][g])]=n+h;return o},e.computeMacroBlockMappingTables=function(t,e,s,i){const r=[[],[]];let h,o,n,c=0,a=0,f=0,d=0,l=0,b=0,m=2,u=2,p=0;for(p=0;p<3;p+=1)for(0!==p&&(0===s?(m=1,u=1):2===s&&(m=1,u=2)),d=0;d<e;d+=1)for(l=d%2,o=0;o<u;o+=1)for(h=l,f=0;f<t;f+=1){for(b=(d-l)*t+h,void 0===r[1][b]&&(r[1][b]=[]),n=0;n<m;n+=1)c=i[a],a+=1,r[0][c]=b,r[1][b].push(c);h+=f%2!==l||d===e-1&&0===l?1:3}return r}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(12),r=s(14);e.TransportStream=class{constructor(t){this.byteStream=t,this.logicalStreams=[]}findLogicalStreams(){let t;for(t=this.nextPage();t.isBeginOfStream();)this.logicalStreams.push(new i.LogicalStream(this,t)),t=this.nextPage();return this.byteStream.skip(-(t.headerLength+t.bodyLength)),this.logicalStreams}nextPage(){return new r.Page(this.byteStream)}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(13),r=s(4);e.LogicalStream=class{constructor(t,e){if(!e.isBeginOfStream())throw new r.OggError("LogicalStream must be initialized with a BeginOfStream page.");this.stream=t,this.serialNumber=e.serialNumber,this.lastPageNumber=e.pageSequenceNumber,this.currentPage=e,this.segmentOffset=0,this.rereadFirstPacket=!1}getFirstPacket(){return void 0===this.firstPacket&&(this.firstPacket=this.nextPacket(),this.rereadFirstPacket=!0),this.firstPacket}nextPacket(){if(this.rereadFirstPacket&&void 0!==this.firstPacket)return this.rereadFirstPacket=!1,this.firstPacket;const t=new i.Packet;let e;if(!(e=this.nextSegment()))return!1;for(;255===e.length;)if(t.addSegment(e),!(e=this.nextSegment(!0)))throw new r.OggError("Missing EndOfPacket segment");return t.addSegment(e),void 0===this.firstPacket&&(this.firstPacket=t),t}nextSegment(t){let e;if(this.segmentOffset>=this.currentPage.pageSegments){if(!(e=this.nextPage()))return!1;if(t&&!this.currentPage.isContinuedPage())throw new r.OggError("Page is not a continued page.");this.segmentOffset=0}const s=this.currentPage.segments[this.segmentOffset];return this.segmentOffset+=1,s}nextPage(){let t;if(this.currentPage.isEndOfStream())return!1;do{t=this.stream.nextPage()}while(t.serialNumber!==this.serialNumber&&!t.isEndOfStream());if(t.pageSequenceNumber-1!==this.lastPageNumber)throw new r.OggError("Lost data; missing page.");return this.lastPageNumber=t.pageSequenceNumber,this.currentPage=t,!0}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.Packet=class{constructor(){this.data=[],this.offset=0}addSegment(t){0!==t.length&&(this.data=this.data.concat(t))}getLength(){return this.data.length}next8(){const t=this.get8(this.offset);return this.offset+=1,t}next16(){return this.next8()<<8|this.next8()}next24(){return this.next8()<<16|this.next16()}next32(){return this.next8()<<24|this.next24()}get8(t){return this.data[t]}skip(t){this.offset+=t}seek(t){this.offset=t}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(4);e.Page=class{constructor(t){let e;if(this.stream=t,this.capturePattern=String.fromCharCode(t.next8(),t.next8(),t.next8(),t.next8()),!this.isValid())throw new i.OggError("Page has invalid capturePattern.");for(this.version=t.next8(),this.headerType=t.next8(),this.granulePosition=t.next64(!0),this.serialNumber=t.next32(!0),this.pageSequenceNumber=t.next32(!0),this.checksum=t.next32(!0),this.pageSegments=t.next8(),this.segmentTable=[],this.segments=[],this.headerLength=27+this.pageSegments,this.bodyLength=0,e=0;e<this.pageSegments;e+=1)this.segmentTable[e]=t.next8(),this.bodyLength+=this.segmentTable[e];for(e=0;e<this.pageSegments;e+=1)this.segments.push(this.stream.nextArray(this.segmentTable[e]))}isValid(){return"OggS"===this.capturePattern}isContinuedPage(){return 1==(1&this.headerType)}isEndOfStream(){return 4==(4&this.headerType)}isBeginOfStream(){return 2==(2&this.headerType)}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(0);e.RGBRenderer=class{constructor(t,e={withAlphaChannel:!1}){this.decoder=t,this.options=e,this.bytesPerPixel=e.withAlphaChannel?4:3,this.currentBuffer=new Uint8Array(t.height*t.width*this.bytesPerPixel),0===t.pixelFormat?(this.horizontalPlaneDivisor=2,this.verticalPlaneDivisor=2):2===t.pixelFormat?(this.horizontalPlaneDivisor=2,this.verticalPlaneDivisor=1):(this.horizontalPlaneDivisor=1,this.verticalPlaneDivisor=1)}nextRGBFrame(){const t=this.decoder.nextFrame();if(!t)return!1;for(const e of t.changedPixels){const[s,r]=e;if(!this.isOutsideOfPictureRegion(s,r)){const[e,h]=this.determineTargetCoordinate(s,r),o=r/this.verticalPlaneDivisor|0,n=s/this.horizontalPlaneDivisor|0,c=i.yCbCrToRGB(t.recy[r][s],t.reccb[o][n],t.reccr[o][n]),a=(this.decoder.width*h+e)*this.bytesPerPixel;this.currentBuffer[a]=c[0],this.currentBuffer[a+1]=c[1],this.currentBuffer[a+2]=c[2],this.options.withAlphaChannel&&(this.currentBuffer[a+3]=255)}}return new Uint8Array(this.currentBuffer)}isOutsideOfPictureRegion(t,e){return t<=this.decoder.xOffset||e<=this.decoder.yOffset}determineTargetCoordinate(t,e){return[t-this.decoder.xOffset,this.decoder.height-(e-this.decoder.yOffset)-1]}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});const i=s(17),r=function(t,e){const s=new XMLHttpRequest;s.overrideMimeType("text/plain; charset=x-user-defined"),s.open("GET",t,!0),s.onreadystatechange=function(){4===s.readyState&&"function"==typeof e&&e(s.responseText)},s.send(null)};e.AjaxStream=class extends i.ByteStream{constructor(t){super(),this.url=t}fetch(t){r(this.url,e=>{this.setData(e),t()})}}},function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.ByteStream=class{constructor(){this.index=0,this.length=0,this.data=""}setData(t){this.data=t,this.length=t.length}next8(){const t=255&this.data.charCodeAt(this.index);return this.index+=1,t}next16(t){const e=this.next8(),s=this.next8();return t?s<<8|e:e<<8|s}next24(t){const e=this.next8(),s=this.next8(),i=this.next8();return t?i<<16|s<<8|e:e<<16|s<<8|i}next32(t){const e=this.next8(),s=this.next8(),i=this.next8(),r=this.next8();return t?r<<24|i<<16|s<<8|e:e<<24|s<<16|i<<8|r}next64(t){const e=this.next8(),s=this.next8(),i=this.next8(),r=this.next8(),h=this.next8(),o=this.next8(),n=this.next8(),c=this.next8();return t?{lowBits:r<<24|i<<16|s<<8|e,highBits:c<<24|n<<16|o<<8|h}:{lowBits:h<<24|o<<16|n<<8|c,highBits:e<<24|s<<16|i<<8|r}}nextArray(t){const e=[];let s;for(this.index+t>=this.length&&(t=this.length-this.index),s=0;s<t;s+=1)e[s]=this.next8();return e}skip(t){this.index+=t}}}]);